<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Boss Tracker - Cabal Online Ultimate Combo (SEA)</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    /* ===== XIN CHÀO CABAL-ER ===== */
    /*!
 * Boss Tracker – Private Project - seavein@gmail.com
 * Unauthorized copying or modification is prohibited.
 */
    
    body {
      font-family: Arial, sans-serif;
      background: #0d1117;
      color: #e6edf3;
      padding: 20px;
      transition: 0.3s;
    }

    h2 {
      text-align: center;
      color: #58a6ff;
      text-shadow: 0 0 10px #58a6ff;
      font-size: 28px;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 15px rgba(88, 166, 255, 0.3);
      transition: 0.3s;
    }

    th, td {
      border: 1px solid rgba(88, 166, 255, 0.2);
      padding: 4px;
      text-align: center;
      color: #c9d1d9;
      white-space: nowrap;
      transition: 0.3s;
    }

    th.channel-col, td.channel-col {
      width: calc(100% / 26);
      white-space: nowrap;
    }

    th {
      background: rgba(88, 166, 255, 0.15);
      color: #58a6ff;
      font-weight: bold;
      text-shadow: 0 0 5px #58a6ff;
    }

    #bossTable tr:nth-child(odd) {
      background-color: rgba(88, 166, 255, 0.05) !important;
    }
    #bossTable tr:nth-child(even) {
      background-color: rgba(88, 166, 255, 0.1) !important;
    }

    input[type="checkbox"] {
      transform: scale(1.5);
      cursor: pointer;
      accent-color: #58a6ff;
      vertical-align: middle;
    }

    .right-clicked {
      outline: 3px solid #ffeb3b !important;
      box-shadow: 0 0 10px #ffeb3b;
      border-radius: 4px;
    }

    .timer {
      font-weight: bold;
      text-shadow: 0 0 8px rgba(255,255,255,0.5);
      display: inline-block;
      margin-left: 6px;
      padding: 2px 6px;
      border-radius: 4px;
      min-width: 50px;
      vertical-align: middle;
    }

    .blue { background-color: #0077ff !important; color: white; }
    .green { background-color: #00cc44 !important; color: black; }
    .yellow { background-color: #ffcc00 !important; color: black; }
    .red { background-color: #ff0033 !important; color: white; }

    #notifications {
      margin-top: 25px;
      text-align: center;
      position: relative;
    }

    #notifications div {
      width: 60%;
      margin: 8px auto;
      padding: 8px;
      border-radius: 6px;
      font-weight: bold;
      color: black;
      box-shadow: 0 0 10px rgba(255,255,255,0.3);
      position: relative;
    }

    .highlight-row td {
      background-color: rgba(255, 255, 255, 0.08) !important;
    }
    .highlight-col {
      background-color: rgba(255, 255, 255, 0.12) !important;
    }

    body.light {
      background: #f2f2f2;
      color: #222;
    }

    body.light table {
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
    }

    body.light th {
      background: #d0e4ff;
      color: #003366;
      text-shadow: none;
    }

    body.light td {
      color: #222;
      border-color: #aac4e6;
    }

    body.light #bossTable tr:nth-child(odd) {
      background-color: #f7fbff !important;
    }
    body.light #bossTable tr:nth-child(even) {
      background-color: #eaf4ff !important;
    }

    body.light .timer {
      text-shadow: none;
    }

    body.light #notifications div {
      color: black;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
    }

    body.light .highlight-row td {
      background-color: rgba(0, 0, 0, 0.05) !important;
    }
    body.light .highlight-col {
      background-color: rgba(0, 0, 0, 0.08) !important;
    }

    #themeToggle {
      padding: 6px 12px;
      background: #58a6ff;
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(88,166,255,0.4);
      transition: 0.3s;
      font-size: 13px;
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 999;
    }

    body.light #themeToggle {
      background: #003366;
      color: white;
    }

    #logButton {
      padding: 6px 12px;
      background: #ff9800;
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(255,152,0,0.4);
      transition: 0.3s;
      font-size: 13px;
      position: fixed;
      right: 20px;
      bottom: 60px;
      z-index: 999;
    }

    body.light #logButton {
      background: #cc7a00;
    }

    #columnSelector {
      margin-top: 20px;
      padding: 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(88,166,255,0.3);
    }
    #columnSelector label {
      margin-right: 12px;
      cursor: pointer;
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>

<body>

<audio id="alertSound">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<h2>Boss Tracker - Cabal Ultimate Combo (SEA)</h2>
<table id="bossTable"></table>
<div id="notifications"></div>

<button id="themeToggle">Light Mode</button>
<button id="logButton">LOG</button>
<div id="columnSelector"></div>

<script>
/* ====== PHẦN JS + TỐI ƯU NHẸ ====== */

/* ---------- THEME ---------- */
const themeToggle = document.getElementById("themeToggle");
function applyTheme(mode) {
  document.body.classList.toggle("light", mode === "light");
  themeToggle.textContent = mode === "light" ? "Dark Mode" : "Light Mode";
}
const savedTheme = localStorage.getItem("themeMode") || "dark";
applyTheme(savedTheme);
themeToggle.onclick = () => {
  const m = document.body.classList.contains("light") ? "dark" : "light";
  applyTheme(m);
  localStorage.setItem("themeMode", m);
};
document.getElementById("logButton").onclick = () => location.href = "log.html";

/* ---------- FIREBASE ---------- */
firebase.initializeApp({
  apiKey: "AIzaSyCjnE-pTZymLmDafzfBwMOZu9lG8VYFNJA",
  databaseURL: "https://boss-tracker-v2-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db = firebase.database();

/* ---------- SERVER TIME ---------- */
let serverOffset = 0;
db.ref(".info/serverTimeOffset").on("value", s => serverOffset = s.val() || 0);
function now() { return Date.now() + serverOffset; }

/* ---------- DATA ---------- */
const bosses = ["Manticore","Dark Kimzark","Minisha","Pluma","Pena Top","Pena Bot","Quadra","Tank Top","Tank Bot","Cây","Sói","Bò","Cauda"];
const table = document.getElementById("bossTable");
const notifications = document.getElementById("notifications");
const columnSelector = document.getElementById("columnSelector");

/* ---------- COLUMN SELECT ---------- */
bosses.forEach((boss, i) => {
  columnSelector.innerHTML += `<label><input type="checkbox" class="colToggle" data-col="${i+1}" checked> ${boss}</label>`;
});
const savedCols = JSON.parse(localStorage.getItem("columnVisibility") || "{}");
document.querySelectorAll(".colToggle").forEach(cb => {
  if (savedCols[cb.dataset.col] !== undefined) cb.checked = savedCols[cb.dataset.col];
});
function toggleColumn(i, show) {
  [...table.rows].forEach(r => r.cells[i] && (r.cells[i].style.display = show ? "" : "none"));
}
document.addEventListener("change", e => {
  if (!e.target.classList.contains("colToggle")) return;
  toggleColumn(+e.target.dataset.col, e.target.checked);
  const save = {};
  document.querySelectorAll(".colToggle").forEach(cb => save[cb.dataset.col] = cb.checked);
  localStorage.setItem("columnVisibility", JSON.stringify(save));
});

/* ---------- TABLE ---------- */
let header = "<tr><th class='channel-col'>Channel</th>";
bosses.forEach(b => header += `<th>${b}</th>`);
header += "</tr>";
table.innerHTML = header;

for (let ch = 1; ch <= 30; ch++) {
  let row = `<tr><td class="channel-col">${ch}</td>`;
  bosses.forEach(b => {
    const id = `${ch}_${b}`;
    row += `<td><input type="checkbox" id="${id}"><div class="timer" id="t_${id}">--</div></td>`;
  });
  row += "</tr>";
  table.insertAdjacentHTML("beforeend", row);
}
document.querySelectorAll(".colToggle").forEach(cb => toggleColumn(+cb.dataset.col, cb.checked));

/* ---------- HIGHLIGHT (TỐI ƯU) ---------- */
let lastCell = null;
table.addEventListener("mouseover", e => {
  const cell = e.target.closest("td,th");
  if (!cell || cell === lastCell) return;
  lastCell = cell;

  table.querySelectorAll(".highlight-row").forEach(r => r.classList.remove("highlight-row"));
  table.querySelectorAll(".highlight-col").forEach(c => c.classList.remove("highlight-col"));

  const col = cell.cellIndex;
  cell.parentElement.classList.add("highlight-row");
  [...table.rows].forEach(r => r.cells[col] && r.cells[col].classList.add("highlight-col"));
});
table.addEventListener("mouseleave", () => {
  table.querySelectorAll(".highlight-row").forEach(r => r.classList.remove("highlight-row"));
  table.querySelectorAll(".highlight-col").forEach(c => c.classList.remove("highlight-col"));
});

/* ---------- TIMER (GLOBAL TICK) ---------- */
let timersData = {};
let globalTick = null;

function ensureGlobalTick() {
  if (globalTick) return;

  globalTick = setInterval(() => {
    document.querySelectorAll(".timer[data-start]").forEach(cell => {

      const start = +cell.dataset.start;
const RESPAWN_SEC = 240 * 60;
const elapsed = Math.floor((now() - start) / 1000);
const remain = RESPAWN_SEC - (elapsed % RESPAWN_SEC);

      // ===== HẾT TIME → CHỈ HIỂN THỊ =====
if (remain <= 0) {
  cell.textContent = "Respawn";
  cell.className = "timer red";
  return;
}


      if (remain > 0 && cell.dataset.resetDone) {
        delete cell.dataset.resetDone;
      }

      // ===== SOS =====
      if (cell.dataset.sosStart && !cell.dataset.sosOff) {
        const sosElapsed = Math.floor((now() - cell.dataset.sosStart) / 1000);

        if (sosElapsed <= 300) {
          if (Math.floor(now() / 1000) % 2 === 0) {
            cell.textContent = "_SoS_";
            cell.className = "timer red";
            return;
          }
        } else {
          delete cell.dataset.sosStart;
        }
      }

      // ===== HIỂN THỊ THỜI GIAN =====
      cell.textContent =
        String(Math.floor(remain/60)).padStart(2,'0') + ":" +
        String(remain%60).padStart(2,'0');

      cell.className = "timer";
      cell.classList.add(
        remain >= 235*60 ? "blue" :
        remain > 5*60 ? "green" :
        remain > 3*60 ? "yellow" : "red"
      );

    });

    updateNotifications();
  }, 1000);
}

function startTimer(id, startTime, sosStart = null, sosOff = false) {
  const cell = document.getElementById("t_" + id);
  const cb = document.getElementById(id);
  if (!cell || !cb) return;

  cb.checked = true;
  cell.dataset.start = startTime;

  if (sosStart) {
  cell.dataset.sosStart = sosStart;
} else {
  delete cell.dataset.sosStart;
}


  if (sosOff) cell.dataset.sosOff = "1";
  else delete cell.dataset.sosOff;

  delete cell.dataset.done;

  ensureGlobalTick();
}

function stopTimer(id) {
  const cell = document.getElementById("t_" + id);
  const cb = document.getElementById(id);
  if (!cell || !cb) return;

  delete cell.dataset.start;
  delete cell.dataset.done;
  cell.textContent = "--";
  cell.className = "timer";
  cb.checked = false;
}

/* ---------- FIREBASE TIMER SYNC ---------- */
db.ref("timers").on("child_added", s => {
  timersData[s.key] = s.val();
  if (s.val().checked) {
    startTimer(
      s.key,
      s.val().startTime,
      s.val().sosStart,
      s.val().sosOff
    );
  }
});

  
  db.ref("timers").on("child_changed", s => {
  const old = timersData[s.key];
  const data = s.val();
  timersData[s.key] = data;

  // Nếu startTime thay đổi → reset → phát âm thanh
  if (old && old.startTime !== data.startTime) {
    try { document.getElementById("alertSound").play(); } catch(e){}
  }

  if (data.checked) {
    startTimer(s.key, data.startTime, data.sosStart, data.sosOff);
  }
});

  

db.ref("timers").on("child_removed", s => {
  delete timersData[s.key];
  stopTimer(s.key);
});

/* ---------- NOTIFICATIONS ---------- */
function updateNotifications() {
  let list = [];
  Object.entries(timersData).forEach(([id,d]) => {
    if (!d.checked) return;
    const r = 240*60 - Math.floor((now()-d.startTime)/1000);
    if (r <= 0) return;
    const [ch,b] = id.split("_");
    list.push({ch,b,r});
  });
  list.sort((a,b)=>a.r-b.r);
  notifications.innerHTML = "";
  list.slice(0,5).forEach(i => {
    const div = document.createElement("div");
    div.textContent = `Kênh ${i.ch} - Boss ${i.b} - Còn ${String(Math.floor(i.r/60)).padStart(2,'0')}:${String(i.r%60).padStart(2,'0')}`;
    div.className = i.r>=235*60?"blue":i.r>5*60?"green":i.r>3*60?"yellow":"red";
    notifications.appendChild(div);
  });
}

/* ---------- EVENTS ---------- */
bosses.forEach(b => {
  for (let ch = 1; ch <= 30; ch++) {
    const id = `${ch}_${b}`;
    const cb = document.getElementById(id);
    const cell = document.getElementById("t_" + id);

    cb.onchange = e => {
  if (e.target.checked) {
  // Tick → start timer như cũ
  db.ref("timers/" + id).set({
    checked: true,
    startTime: now()
  });

  //Lưu log check
  db.ref("logs").push({
    id: id,
    time: now(),
    action: "check"
  });

  return;
}

  // ===== UNTICK =====
  const data = timersData[id];
  if (!data || !data.startTime) {
    db.ref("timers/" + id).remove();
    return;
  }

  const remain =
    240 * 60 - Math.floor((now() - data.startTime) / 1000);

  // Chỉ hỏi khi 5–230 phút
  if (remain >= 3 * 60 && remain <= 238 * 60) {
    const ok = confirm("Bạn có muốn reset time boss?");
    if (!ok) {
      // Người dùng bấm NO → bật lại checkbox, không reset
      e.target.checked = true;
      return;
    }
  }

  // YES hoặc ngoài khoảng → reset
  db.ref("timers/" + id).remove();
//Lưu log Uncheck
      db.ref("logs").push({
    id: id,
    time: now(),
    action: "uncheck"
});
};


    cb.oncontextmenu = e => {
      e.preventDefault();
      const ref = db.ref("colors/"+id);
      ref.once("value").then(s => s.exists() ? ref.remove() : ref.set(true));
    };

    cell.oncontextmenu = e => {
      e.preventDefault();
      const m = parseInt(prompt("Nhập số PHÚT muốn đếm ngược:"),10);
      if (!m || m<=0) return alert("Vui lòng nhập số nguyên dương!");
      const newStart = now() - (240*60 - m*60)*1000;
      db.ref("timers/"+id).set({checked:true,startTime:newStart});
      cb.checked = true;
    };
    //xử lý CLICK TRÁI vào timer
    cell.onclick = () => {
  const id = cell.id.replace("t_", "");
  db.ref("timers/" + id).update({ sosOff: true });// Tắt SoS

};

    
  }
});

/* ---------- COLORS ---------- */
db.ref("colors").on("child_added", s => document.getElementById(s.key)?.classList.add("right-clicked"));
db.ref("colors").on("child_removed", s => document.getElementById(s.key)?.classList.remove("right-clicked"));
</script>

</body>
</html>






















